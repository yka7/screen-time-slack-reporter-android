name: Coverage Check

on:
  pull_request:
    branches: [ main ]

jobs:
  coverage:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    - name: Run tests with coverage
      run: ./gradlew jacocoTestReport
    
    - name: Check coverage threshold
      run: |
        REPORT_XML="app/build/reports/jacoco/jacocoTestReport/jacocoTestReport.xml"
        if [ ! -f "$REPORT_XML" ]; then
          echo "Warning: JaCoCo XML report not found at $REPORT_XML; skipping threshold check"
          exit 0
        fi

        LINE_COUNTER=$(grep -oP '<counter type="LINE" missed="\d+" covered="\d+"\s*/>' "$REPORT_XML" | tail -n 1)
        if [ -z "$LINE_COUNTER" ]; then
          echo "Warning: Could not find LINE counter in JaCoCo XML; skipping threshold check"
          exit 0
        fi

        MISSED=$(echo "$LINE_COUNTER" | grep -oP 'missed="\K\d+')
        COVERED=$(echo "$LINE_COUNTER" | grep -oP 'covered="\K\d+')

        TOTAL=$((MISSED + COVERED))
        if [ "$TOTAL" -eq 0 ]; then
          echo "Warning: Total LINE count is 0; skipping threshold check"
          exit 0
        fi

        COVERAGE=$((COVERED * 100 / TOTAL))
        echo "Current line coverage: ${COVERAGE}% (covered=${COVERED}, missed=${MISSED})"
        if [ "$COVERAGE" -lt 70 ]; then
          echo "Coverage ${COVERAGE}% is below threshold 70%"
          exit 1
        fi
        echo "Coverage check passed: ${COVERAGE}% >= 70%"
