# PR-001: Webhook URLの暗号化保存

**Status**: Proposed
**Priority**: Medium
**Addresses**: ISS-001
**Assumption**: ASM-005（Webhook URLが平文でPreferences DataStoreに保存されている）

> ※この提案はASM-005という仮定に基づいています。

## 概要

Slack Incoming Webhook URLは秘匿情報である（README.md:108-112で明示的に注意喚起）。
現在、Preferences DataStoreに平文保存されているため、root化端末やバックアップ経由で漏洩するリスクがある。

## 変更内容

### 1. 依存関係追加

```kotlin
// app/build.gradle.kts
implementation("androidx.security:security-crypto:1.1.0-alpha06")
```

### 2. 暗号化ストレージの実装

```kotlin
// 新規: data/settings/EncryptedPreferences.kt
class EncryptedPreferences @Inject constructor(
    @ApplicationContext private val context: Context
) {
    private val masterKey = MasterKey.Builder(context)
        .setKeyScheme(MasterKey.KeyScheme.AES256_GCM)
        .build()

    private val encryptedPrefs = EncryptedSharedPreferences.create(
        context,
        "encrypted_settings",
        masterKey,
        EncryptedSharedPreferences.PrefKeyEncryptionScheme.AES256_SIV,
        EncryptedSharedPreferences.PrefValueEncryptionScheme.AES256_GCM
    )

    fun setWebhookUrl(url: String) {
        encryptedPrefs.edit().putString("webhook_url", url).apply()
    }

    fun getWebhookUrl(): String {
        return encryptedPrefs.getString("webhook_url", "") ?: ""
    }
}
```

### 3. PreferencesDataStoreからWebhook URL読み書きを移行

- `PreferencesDataStore.setWebhookUrl()` → `EncryptedPreferences.setWebhookUrl()`
- `PreferencesDataStore.settingsFlow` 内の `webhookUrl` → `EncryptedPreferences.getWebhookUrl()`

### 4. マイグレーション

既存ユーザーのWebhook URLを平文DataStoreから暗号化ストレージに移行する1回限りのマイグレーション処理を実装。

## 影響範囲

| ファイル | 変更種別 |
|---------|---------|
| `app/build.gradle.kts` | 依存関係追加 |
| `data/settings/EncryptedPreferences.kt` | 新規作成 |
| `data/settings/PreferencesDataStore.kt` | Webhook URL関連の読み書き修正 |
| `di/AppModule.kt` | EncryptedPreferences提供追加 |

## テスト計画

- `EncryptedPreferencesTest`: 暗号化保存・読み取りの正常動作
- `PreferencesDataStoreTest`: 既存テストの修正（Webhook URL関連）
- マイグレーションテスト: 平文→暗号化の移行確認

## リスクと軽減策

| リスク | 軽減策 |
|--------|--------|
| security-crypto ライブラリの互換性 | minSdk=23をサポートするalpha版を使用 |
| 暗号化キーの紛失（アプリ再インストール時） | Webhook URLの再入力を案内 |
| パフォーマンス影響 | Webhook URLの読み取りは設定変更時のみ（頻度低） |

## ロールバック手順

1. `EncryptedPreferences.kt` を削除
2. `PreferencesDataStore.kt` を元に戻す
3. `app/build.gradle.kts` から `security-crypto` 依存を削除
4. `./gradlew clean assembleDebug` でビルド確認

## 期待効果

- Webhook URLがAndroid Keystoreで保護された暗号化ストレージに保存される
- root化端末でもWebhook URLの直接読み取りが困難になる
