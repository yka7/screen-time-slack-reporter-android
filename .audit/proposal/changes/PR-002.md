# PR-002: Worker失敗時のエラー通知

**Status**: Proposed
**Priority**: Medium
**Addresses**: ISS-007

## 概要

DailySlackReportWorkerがバックグラウンドで失敗した場合、保護者に通知されずSlack送信が行われないことがある。
Worker失敗時にAndroid通知を表示し、保護者がエラーに気づける仕組みを追加する。

## 変更内容

### 1. 通知チャンネルの作成

```kotlin
// App.kt または NotificationHelper.kt
private fun createNotificationChannels() {
    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
        val errorChannel = NotificationChannel(
            "error_notifications",
            "エラー通知",
            NotificationManager.IMPORTANCE_DEFAULT
        ).apply {
            description = "Slack送信エラー発生時の通知"
        }
        notificationManager.createNotificationChannel(errorChannel)
    }
}
```

### 2. Worker失敗時の通知

```kotlin
// DailySlackReportWorker.kt
override suspend fun doWork(): Result {
    return try {
        // 既存の処理
        Result.success()
    } catch (e: Exception) {
        showErrorNotification(e.message ?: "不明なエラー")
        if (runAttemptCount < 3) {
            Result.retry()
        } else {
            Result.failure()
        }
    }
}

private fun showErrorNotification(message: String) {
    val notification = NotificationCompat.Builder(applicationContext, "error_notifications")
        .setSmallIcon(R.drawable.ic_error)
        .setContentTitle("Slack送信に失敗しました")
        .setContentText(message)
        .setPriority(NotificationCompat.PRIORITY_DEFAULT)
        .setAutoCancel(true)
        .build()
    
    notificationManager.notify(ERROR_NOTIFICATION_ID, notification)
}
```

## 影響範囲

| ファイル | 変更種別 |
|---------|---------|
| `AndroidManifest.xml` | POST_NOTIFICATIONS権限追加（API 33+） |
| `App.kt` | 通知チャンネル作成 |
| `workers/DailySlackReportWorker.kt` | エラー通知処理追加 |
| `res/drawable/ic_error.xml` | 新規作成（エラーアイコン） |

## リスクと軽減策

| リスク | 軽減策 |
|--------|--------|
| 通知権限が拒否される（API 33+） | 権限ダイアログでの説明、設定画面への誘導 |
| 通知が多すぎる | リトライ成功時は通知しない、最終失敗時のみ通知 |

## ロールバック手順

1. `DailySlackReportWorker.kt` から通知処理を削除
2. `AndroidManifest.xml` から通知権限を削除
3. `./gradlew clean assembleDebug` でビルド確認

## 期待効果

- バックグラウンドでのSlack送信失敗を保護者が認識できる
- Usage Access権限の無効化など、設定問題への気づきを促進
